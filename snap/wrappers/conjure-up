#!/bin/bash

set -eu

log() {
    echo -e "\e[32m\e[1m[info]\e[0m $@"
}

if [ -f "/usr/bin/lxc" ]; then
    echo ""
    log "In order for conjure-up to provide a seamless out of the box deploy"
    log "experience we need to upgrade the underlying container component. "
    log "If you have existing LXD containers running they will be affected "
    log "and should be backed up prior to continuing."
    echo ""
    echo -n "Continue with conjure-up deployment? [y/N]: "
    read -n 1 proceed
    if [ "$proceed" == "y" ] || [ "$proceed" == "Y" ]; then
        echo ""
        log "Upgrading container subsystem"
        sudo apt-get -qyf remove lxd lxd-client > /dev/null 2>&1
    else
        exit 0
    fi
fi

APPLANG=en_US
APPENC=UTF-8
APPLOC="$APPLANG.$APPENC"

export LC_ALL=$APPLOC
export LANG=$APPLOC
export LANGUAGE=${APPLANG%_*}

snap_lxd_socket=/var/snap/lxd/common/lxd

export LXD_DIR=$snap_lxd_socket
# Make sure we access our python and juju binaries first
export PATH=$SNAP/bin:$SNAP/usr/bin:/snap/bin:$PATH

LXCBIN=/snap/bin/lxc

$LXCBIN finger > /dev/null 2>&1
if ! $LXCBIN network show lxdbr0 > /dev/null 2>&1; then
    log "Verifying conjure-up pre-requisites"
    $LXCBIN network create lxdbr0 ipv4.address=10.0.8.1/24 ipv4.nat=true ipv6.address=none ipv6.nat=false > /dev/null 2>&1 || true
fi

if ! $LXCBIN network show conjureup0 > /dev/null 2>&1; then
    $LXCBIN network create conjureup0 ipv4.address=10.99.0.1/24 ipv4.nat=true ipv6.address=none ipv6.nat=false > /dev/null 2>&1 || true
fi

exec $SNAP/bin/conjure-up -c $SNAP/etc/conjure-up.conf \
     --spells-dir $SNAP/spells --nosync "$@"
